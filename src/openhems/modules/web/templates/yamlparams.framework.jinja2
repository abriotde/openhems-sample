<!DOCTYPE html>
<html lang="en">
<head>
	<title>OpenHEMS</title>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="{{request.static_url('openhems.modules.web:../../../../img/openhems.css')}}">
	<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
	<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
</head>
<body>
<nav class="menu">
  <ul>
    <li><a href="/">Devices program</a></li>
    <li><a href="https://github.com/abriotde/openhems-sample/tree/main">More</a></li>
  </ul>
</nav>
<div class="page">
	<h1>Parameters</h1>
	<div><img id="waitImg" src="{{request.static_url('openhems.modules.web:../../../../img/wait.gif')}}" style="display:none" alt="Wait"></img><div>
	<div>VPN is <b id="vpnStatus">{{ vpn }}</b>.<button id="vpnButton"></button></div>

	<form name="yamlParamsForm" action="/yamlparams" method="POST" onsubmit="return setNetwork()">
	<div id="yamlParams">
		{%YAML_PARAMS%}
	</div>
	<input id="submitYamlParams" type="submit" value="Submit" src="{{request.static_url('openhems.modules.web:../../../../img/correct_32.ico')}}">
	</form>
</div>
<script>
const vpn = {{ vpn|tojson }};
const vpnButton = document.getElementById("vpnButton");
const vpnStatus = document.getElementById("vpnStatus");
const waitImg = document.getElementById("waitImg");
var network = []
if (vpn=="up") {
	connectedVPN(true);
} else {
	connectedVPN(false);
}
/**
	Function to initiate page to the state of the VPN.
	@param : bool : True if VPN is connected.
*/
function connectedVPN(connect) {
	url = "/vpn?connect="+(connect?"false":"true");
	vpnButton.onclick = function () {
		waitImg.style.display = "inline";
		vpnButton.style.display = "none";
		fetch(url, { method: 'GET' })
			.then(Result => Result.json())
			.then(retVal => {
				console.log('response :  '+retVal);
				connectedVPN(retVal.connected);
				waitImg.style.display = "none";
				vpnButton.style.display = "inline";
			})
			.catch(errorMsg => { console.log(errorMsg); }); 
	}
	vpnButton.innerHTML = connect?"Disconnect":"Connect";
	vpnStatus.innerHTML = connect?"up":"down";
}
function changeSthg() {
	// console.log("changeSthg()");
		document.getElementById("submitYamlParams")
			.src = "{{request.static_url('openhems.modules.web:../../../../img/save_32.ico')}}";
}
function getNetwork() {
	val = document.getElementById('network.nodes').value.trim().replaceAll("'","\"");
	console.log("Network0:",val);
	network = JSON.parse(val);
	console.log("Network:",network);
}
function setNetwork() {
	document.getElementById('network.nodes').value = JSON.stringify(network);
	return true;
}
function getElement(index, attr, node, level=0) {
	var currentElement = document.createElement("div");
	if (level>0) {
		currentElement.classList.add("col-75");
	}
	currentElement.classList.add(index);
	var myindex = index+"-"+attr;
	if (typeof(node)=="object") {
		currentElement.id = myindex;
		currentElement.classList.add("config_"+level);
		for(var a in node){
			var rowElement = document.createElement("div");
			rowElement.classList.add("row");
			var labelElement = document.createElement("div");
			labelElement.classList.add("col-25");
			if (a=="class") {
				label = "Type";
			} else if (a=="class") {
				label = "Identifier";
			} else {
				label = a;
			}
			labelElement.innerHTML = "<label for='"+myindex+"-"+a+"'>"
				+label+"</label>";
			rowElement.appendChild(labelElement);
			var attrElement = getElement(myindex, a, node[a], level+1);
			rowElement.appendChild(attrElement);
			currentElement.appendChild(rowElement);
		}
	} else {
		custumInputAttr = ""
		if (attr=="class") {
			custumInputAttr = "readonly ";
			attr = "Type";
		} else if (attr=="class") {
			attr = "Identifier";
		}
		currentElement.innerHTML = "<input type='text' id='"+myindex+"'"
			+custumInputAttr+"value='"+node+"'/>";
	}
	return currentElement;
}
function addNode(index, node) {
	alert("Add Node");
}
function displayNode(index, node) {
	currentElement = getElement("node", index, node);
	document.getElementById("nodes").appendChild(currentElement);
}
function displayNetwork() {
	for (n in network) {
		node = network[n];
		console.log("Node:", node);
		displayNode(n, node);
	}
}
$( function() {
	$( "#yamlParams" ).tabs();
	getNetwork();
	displayNetwork();
} );
</script>
</body>
</html>
